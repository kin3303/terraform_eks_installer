# https://developer.hashicorp.com/consul/tutorials/kubernetes/kubernetes-vault-consul-secrets-management
# https://github.com/hashicorp/learn-consul-kubernetes/blob/main/hcp-vault-eks/consul-values.yaml
# https://developer.hashicorp.com/consul/docs/k8s/deployment-configurations/vault/data-integration/webhook-certs

# Store Consul gossip key in Vault
#    vault secrets enable -path=consul kv-v2
#    consul keygen
#       8a5pzlWytikR3HwU6GHeNXe7kZKMcxo2N8Z4H0+nbjI=
#    vault kv put consul/secret/gossip gossip="8a5pzlWytikR3HwU6GHeNXe7kZKMcxo2N8Z4H0+nbjI="
#
# Setup PKI secrets engine for TLS and service mesh CA
#    vault secrets enable pki
#    vault secrets enable -path connect-root pki
#    vault secrets enable -path=controller pki
#    vault secrets enable -path=connect-inject pki
#
#    vault secrets tune -max-lease-ttl=87600h pki
#    vault secrets tune -max-lease-ttl=87600h connect-root
#    vault secrets tune -max-lease-ttl=87600h controller
#    vault secrets tune -max-lease-ttl=87600h connect-inject
#
#    vault write -field=certificate pki/root/generate/internal common_name="dc1.consul"  ttl=87600h
#    vault write -field=certificate controller/root/generate/internal common_name="consul-controller-webhook"  ttl=87600h
#    vault write -field=certificate connect-inject/root/generate/internal common_name="consul-connect-injector" ttl=87600h
#
#    vault write pki/roles/consul-server `
#        allowed_domains="dc1.consul,consul-server,consul-server.consul,consul-server.consul.svc" `
#        allow_subdomains=true `
#        allow_bare_domains=true `
#        allow_localhost=true `
#        generate_lease=true `
#        max_ttl="720h"
#
#    vault write controller/roles/controller-role `
#        allowed_domains="consul-controller-webhook,consul-controller-webhook.consul,consul-controller-webhook.consul.svc,consul-controller-webhook.consul.svc.cluster.local" `
#        allow_subdomains=true `
#        allow_bare_domains=true `
#        allow_localhost=true `
#        generate_lease=true `
#        max_ttl="720h"
#    
#     vault write connect-inject/roles/connect-inject-role `
#        allowed_domains="consul-connect-injector,consul-connect-injector.consul,consul-connect-injector.consul.svc,consul-connect-injector.consul.svc.cluster.local" `
#        allow_subdomains=true `
#        allow_bare_domains=true `
#        allow_localhost=true `
#        generate_lease=true `
#        max_ttl="720h"

# Configure Kubernetes authentication
#    vault auth enable kubernetes
#    kubectl config view --raw --minify --flatten -o jsonpath='{.clusters[].cluster.server}'
#       https://BAEE9A570032DF9C668E984CE11C2CAC.yl4.ap-northeast-2.eks.amazonaws.com
#    $kubernetesHostURL = "https://BAEE9A570032DF9C668E984CE11C2CAC.yl4.ap-northeast-2.eks.amazonaws.com" 
#    $secretName = (kubectl get serviceaccount  --namespace vault-server vault-agent-injector  -o jsonpath='{.secrets[0].name}')
#    $jwtTokenEncoded = (kubectl get secret --namespace vault-server $secretName -o jsonpath='{ .data.token }')
#    $jwtToken = ([Text.Encoding]::Utf8.GetString([Convert]::FromBase64String("$jwtTokenEncoded")))
#    $caCertEncoded = (kubectl get secret --namespace vault-server $secretName -o jsonpath='{  .data.ca\.crt }')
#    $caCert = ([Text.Encoding]::Utf8.GetString([Convert]::FromBase64String("$caCertEncoded")))
#    vault write auth/kubernetes/config  token_reviewer_jwt="$jwtToken" kubernetes_host="$kubernetesHostURL" kubernetes_ca_cert="${caCert}"
#
# Generate Vault policies
#
#    gossip-policy
#      path "consul/data/secret/gossip" {
#        capabilities = ["read"]
#      }
#
#    consul-server
#      path "kv/data/consul-server"
#      {
#        capabilities = ["read"]
#      }
#      path "pki/issue/consul-server"
#      {
#        capabilities = ["read","update"]
#      }
#      path "pki/cert/ca"
#      {
#        capabilities = ["read"]
#      }
#
#    ca-policy
#      path "pki/cert/ca" {
#        capabilities = ["read"]
#      }
#
#    connect 
#      path "/sys/mounts/connect-root" {
#        capabilities = [ "create", "read", "update", "delete", "list" ]
#      }
#      path "/sys/mounts/connect-intermediate-dc1" {
#        capabilities = [ "create", "read", "update", "delete", "list" ]
#      }
#      path "/sys/mounts/connect-intermediate-dc1/tune" {
#        capabilities = [ "update" ]
#      }
#      path "/connect-root/*" {
#        capabilities = [ "create", "read", "update", "delete", "list" ]
#      }
#      path "/connect-intermediate-dc1/*" {
#        capabilities = [ "create", "read", "update", "delete", "list" ]
#      }
#      path "auth/token/renew-self" {
#        capabilities = [ "update" ]
#      }
#      path "auth/token/lookup-self" {
#        capabilities = [ "read" ]
#      }
#
#    controller-tls-policy
#      path "controller/issue/controller-role" {
#        capabilities = ["create", "update"]
#      }
#
#    connect-inject-policy
#      path "connect-inject/issue/connect-inject-role" {
#        capabilities = ["create", "update"]
#      }
#
#    connect-inject-ca-policy
#      path "connect-inject/cert/ca" {
#        capabilities = ["read"]
#      }
#
#    controller-ca-policy
#      path "controller/cert/ca" {
#        capabilities = ["read"]
#      }
#
#  Configure Kubernetes authentication roles in Vault
#
#    Consul server role
#      vault write auth/kubernetes/role/consul-server `
#          bound_service_account_names=consul-server `
#          bound_service_account_namespaces=consul `
#          policies="gossip-policy,consul-server,connect" `
#          ttl=24h
#
#    Consul client role
#      vault write auth/kubernetes/role/consul-client `
#          bound_service_account_names=consul-client `
#          bound_service_account_namespaces=consul `
#          policies="gossip-policy,ca-policy" `
#          ttl=24h
#
#    Define access to Consul CA root certificate
#      vault write auth/kubernetes/role/consul-ca `
#          bound_service_account_names="*" `
#          bound_service_account_namespaces=consul `
#          policies=ca-policy `
#          ttl=24h
#
#    Define access to Controller certificate 
#      vault write auth/kubernetes/role/controller-role `
#          bound_service_account_names="*" `
#          bound_service_account_namespaces=consul `
#          policies=gossip-policy,controller-ca-policy `
#          ttl=24h
#
#    Define access to Connect Injector certificate
#      vault write auth/kubernetes/role/connect-inject-role `
#          bound_service_account_names="consul-connect-injector" `
#          bound_service_account_namespaces=consul `
#          policies=gossip-policy,connect-inject-ca-policy `
#          ttl=24h

locals {
  consul_domain     = "consul"
  consul_namespace  = "consul"
  consul_datacenter = "dc1"
}


module "eks_consul_installer" {
  source = "../eks/modules/terraform-aws-eks-consul"

  create_namespace  = true
  chart_namespace   = local.consul_namespace
  consul_datacenter = local.consul_datacenter
  consul_domain     = local.consul_domain

  # global.gossipEncryption
  gossip_enable_auto_generate   = false
  gossip_encryption_secret_name = "consul/data/secret/gossip"
  gossip_encryption_secret_key  = "gossip"

  # tls
  tls_enabled             = true
  tls_enable_auto_encrypt = true
  tls_cacert_secret_name  = "pki/cert/ca"

  # server
  server_expose_gossip_and_rpc_ports = true
  tls_server_cert_secret_name        = "pki/issue/consul-server"

  # metrics
  metrics_enabled        = true
  enable_agent_metrics   = true
  enable_gateway_metrics = true

  # connectInject
  enable_connect_inject                 = true
  connect_inject_by_default             = true
  connect_inject_default_enable_merging = true
  #connect_inject_service_account_annotations = "\"consul.hashicorp.com/connect-inject\": \"true\""

  # acl
  manage_system_acls = false

  # Vault Backend
  enable_secret_backend_vault                 = true
  vault_addr                                  = "http://10.0.2.146:8200"
  vault_consul_server_role                    = "consul-server"
  vault_consul_client_role                    = "consul-client"
  vault_consul_ca_role                        = "consul-ca"
  vault_consul_controller_role                = "controller-role"
  vault_consul_inject_role                    = "connect-inject-role"
  vault_root_pki_path                         = "connect-root/"
  vault_intermediate_pki_path                 = "connect-intermediate-dc1/"
  vault_consul_injector_cacert_secret_path    = "connect-inject/cert/ca"
  vault_consul_injector_tlscert_secret_path   = "connect-inject/issue/connect-inject-role"
  vault_consul_controller_cacert_secret_path  = "controller/cert/ca"
  vault_consul_controller_tlscert_secret_path = "controller/issue/controller-role"

  # ingressGateways    
  ingress_gateway_enable = false
  ingress_gateways = [
    {
      name = "ingress-gateway"
      service = {
        type = "LoadBalancer"
      }
      consulNamespace = local.consul_namespace
    }
  ]

  # terminatingGateways
  terminating_gateway_enable = false
  terminating_gateways = [
    {
      name = "terminating-gateway"
      service = {
        type = "LoadBalancer"
      }
      consulNamespace = local.consul_namespace
    }
  ]


  depends_on = [
    module.eks_vault_installer_test
  ]
}

# UI 활성화 확인
#    kubectl port-forward service/consul-server --namespace consul 8501:8501
#    https://localhost:8501/ui/dc1/services
