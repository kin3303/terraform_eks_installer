locals {
  domain     = "consul"
  namespace  = "consul"
  datacenter = "dc1"
}

module "eks_consul_installer" {
  source           = "../eks/modules/terraform-aws-eks-consul"
  create_namespace = true
  chart_namespace  = local.namespace

  # global
  consul_datacenter = local.datacenter
  consul_domain     = local.domain

  # global.gossipEncryption
  gossip_enable_auto_generate = true

  # global.tls
  tls_enable_auto_encrypt = true

  # client
  client_enable = true

  # global.metrics
  metrics_enabled        = true
  enable_agent_metrics   = true
  enable_gateway_metrics = true

  # Auto connectInject 
  enable_connect_inject = true
  connect_inject_by_default             = false
  connect_inject_default_enable_merging = false
  
  # acl
  manage_system_acls = false
}

# UI 활성화 확인
#    kubectl port-forward service/consul-server --namespace consul 8501:8501
#    https://localhost:8501/ui/dc1/services

#################################################################################
# Backend Service
#################################################################################
resource "kubernetes_service_account" "api_v_1" {
  metadata {
    name = "api-v1"
  }
  depends_on = [
    module.eks_consul_installer
  ]
}

resource "kubernetes_service" "api_v_1" {
  metadata {
    name = "api-v1"
  }

  spec {
    port {
      port        = 9091
      target_port = 9091
    }

    selector = {
      app = "api-v1"
    }
  }
  depends_on = [
    module.eks_consul_installer
  ]
}

resource "kubernetes_deployment" "api_v_1" {
  metadata {
    name = "api-v1"

    labels = {
      app = "api-v1"
    }
  }

  spec {
    replicas = 1

    selector {
      match_labels = {
        app = "api-v1"
      }
    }

    template {
      metadata {
        labels = {
          app = "api-v1"
        }

        annotations = {
          "consul.hashicorp.com/connect-inject" = "true"
        }
      }

      spec {
        container {
          name  = "api"
          image = "nicholasjackson/fake-service:v0.7.8"

          port {
            container_port = 9091
          }

          env {
            name  = "LISTEN_ADDR"
            value = "127.0.0.1:9091"
          }

          env {
            name  = "NAME"
            value = "api-v1"
          }

          env {
            name  = "MESSAGE"
            value = "Response from API v1"
          }
        }
      }
    }
  }
  depends_on = [
    module.eks_consul_installer
  ]
}

#################################################################################
# Frontend Service
#################################################################################

resource "kubernetes_service_account" "web" {
  metadata {
    name = "web"
  }

  depends_on = [
    module.eks_consul_installer
  ]
}

resource "kubernetes_service" "web" {
  metadata {
    name = "web"
  }

  spec {
    port {
      port        = 9090
      target_port = 9090
    }

    selector = {
      app = "web"
    }
  }

  depends_on = [
    module.eks_consul_installer
  ]
}


resource "kubernetes_deployment" "web_deployment" {
  metadata {
    name = "web-deployment"

    labels = {
      app = "web"
    }
  }

  spec {
    replicas = 1

    selector {
      match_labels = {
        app = "web"
      }
    }

    template {
      metadata {
        labels = {
          app = "web"
        }

        annotations = {
          "consul.hashicorp.com/connect-inject"            = "true"
          "consul.hashicorp.com/connect-service-upstreams" = "api-v1:9091"
        }
      }

      spec {
        container {
          name  = "web"
          image = "nicholasjackson/fake-service:v0.7.8"

          port {
            container_port = 9090
          }

          env {
            name  = "LISTEN_ADDR"
            value = "0.0.0.0:9090"
          }

          env {
            name  = "UPSTREAM_URIS"
            value = "http://localhost:9091"
          }

          env {
            name  = "NAME"
            value = "web"
          }

          env {
            name  = "MESSAGE"
            value = "Hello World"
          }
        }
      }
    }
  }

  depends_on = [
    module.eks_consul_installer
  ]
}

#
# Service 확인
#     kubectl port-forward service/web 9090:9090 --address 0.0.0.0
#     http://localhost:9090/ui

